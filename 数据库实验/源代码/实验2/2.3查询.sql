USE newBlog;
-- 1
SELECT * FROM [USER] WHERE [USER].UID IN
	(SELECT UIDFLED FROM FOLLOW WHERE FOLLOW.UID IN
		(SELECT UID FROM [USER] WHERE [USER].NAME = '张三')) ORDER BY [USER].BYEAR DESC,UID ASC;

-- 2
SELECT BID, TITLE, NAME FROM MBLOG,[USER]
	WHERE [USER].UID = MBLOG.UID AND MBLOG.BID NOT IN
		(SELECT BID FROM THUMB) ORDER BY TITLE ASC;

-- 3
SELECT BID FROM MBLOG WHERE MBLOG.BID IN 
	(SELECT BID FROM TOPDAY) AND MBLOG.UID IN
		(SELECT UID FROM [USER] 
		 WHERE [USER].CITY = '武汉' AND 
		 [USER].BYEAR>=2000
	 );
	
-- 4
-- 两次NOT EXISTS等价表示全称量词
SELECT UID FROM [USER] WHERE NOT EXISTS
	(SELECT * FROM LABEL WHERE NOT EXISTS 
		(SELECT * FROM SUB
			WHERE SUB.UID = [USER].UID AND SUB.LID = LABEL.LID
		)
	);

-- 5
SELECT UID,BYEAR,CITY FROM [USER] WHERE BYEAR NOT BETWEEN 1970 AND 2010;

-- 6
SELECT CITY,COUNT(*) FROM [USER] GROUP BY CITY;

-- 7
SELECT CITY,BYEAR,COUNT(*) as 人数
FROM [USER] 
GROUP BY CITY,BYEAR 
ORDER BY CITY ASC,人数 DESC;

-- 8
SELECT BID FROM THUMB GROUP BY BID HAVING COUNT(*)>10;

-- 9
SELECT BID FROM
	(SELECT * FROM THUMB WHERE THUMB.UID IN
		(SELECT UID FROM [USER] WHERE [USER].BYEAR>=2000)
	)#TEMP 
GROUP BY BID HAVING COUNT(*)>10;

-- 10
SELECT BID,COUNT(*) AS COUNT FROM TOPDAY WHERE BID IN
	(SELECT BID FROM
		(SELECT * FROM THUMB WHERE THUMB.UID IN
			(SELECT UID FROM [USER] WHERE [USER].BYEAR>=2000)
		)#TEMP 
	 GROUP BY BID HAVING COUNT(*)>10) 
GROUP BY BID;
-- 11
SELECT DISTINCT UID 
FROM SUB,LABEL 
WHERE SUB.LID = LABEL.LID AND 
LABEL.LNAME IN('文学','艺术','哲学','音乐'); 

-- 12
SELECT * FROM MBLOG 
WHERE CONT LIKE '%最多地铁站%' AND CONT LIKE '%\_华中科技大学%' ESCAPE '\';

-- 13
select #T1.UID,#T2.UID FROM
FOLLOW #T1,FOLLOW #T2
WHERE #T1.UID = #T2.UIDFLED AND
#T1.UIDFLED = #T2.UID AND
#T1.UID<#T2.UID;

-- 14
-- 参考PPT87
SELECT DISTINCT UID FROM FRIENDS A
	WHERE NOT EXISTS
		(SELECT * FROM FRIENDS B
			WHERE B.UID = 5 AND NOT EXISTS
				(SELECT * FROM FRIENDS C
					WHERE C.UID = A.UID AND B.FUID = C.FUID
				)
		);
-- 15
SELECT MBLOG.BID,TITLE,LID FROM MBLOG 
	LEFT OUTER JOIN B_L ON (MBLOG.BID = B_L.BID) WHERE MBLOG.BID IN 
		(SELECT BID FROM TOPDAY WHERE
			TOPDAY.TYEAR = 2019 AND TOPDAY.TMONTH = 4 AND TOPDAY.TDAY = 20
		);
		
-- 16
SELECT 用户A,用户B FROM(
	SELECT T1.UID AS 用户A,T2.UID AS 用户B,COUNT(T1.FUID) AS 共同好友数 
		FROM FRIENDS T1,FRIENDS T2
		WHERE T1.UID<T2.UID AND T1.FUID=T2.FUID
		GROUP BY T1.UID,T2.UID
)TEMP WHERE TEMP.共同好友数>=3;

-- 17
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME = 'TODAY_TOP_TEN')
	DROP VIEW TODAY_TOP_TEN
GO
CREATE VIEW TODAY_TOP_TEN AS SELECT MBLOG.BID,TITLE,[USER].UID,[USER].NAME,TEMP.THUMBSNUM FROM TOPDAY,[USER],MBLOG,
	(SELECT BID,COUNT(*) AS THUMBSNUM FROM THUMB GROUP BY BID)AS TEMP
	WHERE TEMP.BID = TOPDAY.BID
		AND TOPDAY.BID = MBLOG.BID 
		AND MBLOG.UID = [USER].UID
		AND TOPDAY.TYEAR IN (SELECT DATENAME(YEAR,GETDATE())) 
		AND TOPDAY.TMONTH IN (SELECT DATEPART(MONTH,GETDATE())) 
		AND TOPDAY.TDAY IN (SELECT DATEPART(DAY,GETDATE()));